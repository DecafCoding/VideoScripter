@page "/projects/{ProjectId:guid}"

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

@using Microsoft.AspNetCore.Components.Forms
@using VideoScripter.Features.Projects
@using VideoScripter.Features.Projects.Models
@using VideoScripter.Components.Account
@inject ProjectHandler ProjectHandler
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager Navigation

<PageTitle>@(project?.Name ?? "Project Details") - VideoScripter</PageTitle>

<div class="container-fluid">
    <StatusMessage Message="@statusMessage" />
    
    @if (project == null)
    {
        @if (isLoading)
        {
            <div class="d-flex justify-content-center p-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            <div class="text-center p-5">
                <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                <h3>Project Not Found</h3>
                <p class="text-muted">The project you're looking for doesn't exist or you don't have access to it.</p>
                <a href="/projects" class="btn btn-primary">Back to Projects</a>
            </div>
        }
    }
    else
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@project.Name</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <h1>@project.Name</h1>
                <p class="text-muted">@project.Topic</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-outline-secondary me-2" @onclick="EditProject">
                    <i class="bi bi-pencil"></i> Edit Project
                </button>
                <button class="btn btn-outline-danger" @onclick="ConfirmDeleteProject">
                    <i class="bi bi-trash"></i> Delete Project
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-camera-video display-4 text-primary"></i>
                        <h5 class="card-title">Videos</h5>
                        <p class="card-text display-6">@project.VideoCount</p>
                        <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo($"/projects/{ProjectId}/videos"))">
                            <i class="bi bi-plus-circle"></i> Add Videos
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-file-text display-4 text-success"></i>
                        <h5 class="card-title">Scripts</h5>
                        <p class="card-text display-6">@project.ScriptCount</p>
                        <button class="btn btn-success" 
                                disabled="@(project.VideoCount == 0)"
                                @onclick="@(() => Navigation.NavigateTo($"/projects/{ProjectId}/scripts"))">
                            <i class="bi bi-plus-circle"></i> Generate Script
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @if (project.VideoCount == 0)
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Get Started:</strong> Add YouTube videos to begin creating your script. You can add 2-5 videos on a related topic.
            </div>
        }

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Project Details</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8">@project.CreatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")</dd>
                            <dt class="col-sm-4">Last Modified:</dt>
                            <dd class="col-sm-8">@project.LastModifiedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" 
                                    disabled="@(project.VideoCount == 0)"
                                    @onclick="@(() => Navigation.NavigateTo($"/projects/{ProjectId}/transcripts"))">
                                <i class="bi bi-eye"></i> View Transcripts
                            </button>
                            <button class="btn btn-outline-secondary" 
                                    disabled="@(project.ScriptCount == 0)"
                                    @onclick="@(() => Navigation.NavigateTo($"/projects/{ProjectId}/scripts"))">
                                <i class="bi bi-file-text"></i> View Scripts
                            </button>
                            <button class="btn btn-outline-info" @onclick="ExportProject">
                                <i class="bi bi-download"></i> Export Project
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (project.VideoCount > 0)
        {
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted text-center py-3">
                                Recent videos and scripts will be displayed here
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Edit Project Modal -->
<div class="modal fade @(showEditModal ? "show" : "")" 
     style="display: @(showEditModal ? "block" : "none")" 
     tabindex="-1" 
     aria-hidden="@(!showEditModal)">
    <div class="modal-dialog">
        <div class="modal-content">
            <EditForm Model="editForm" OnValidSubmit="SaveProject">
                <DataAnnotationsValidator />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Project</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Project Name</label>
                        <InputText @bind-Value="editForm.Name" 
                                   class="form-control" 
                                   id="projectName" 
                                   placeholder="Enter project name" />
                        <ValidationMessage For="@(() => editForm.Name)" class="text-danger" />
                    </div>
                    <div class="mb-3">
                        <label for="projectTopic" class="form-label">Topic</label>
                        <InputTextArea @bind-Value="editForm.Topic" 
                                       class="form-control" 
                                       id="projectTopic" 
                                       rows="3" 
                                       placeholder="Describe the main topic for your project" />
                        <ValidationMessage For="@(() => editForm.Topic)" class="text-danger" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        }
                        Update
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade @(showDeleteModal ? "show" : "")" 
     style="display: @(showDeleteModal ? "block" : "none")" 
     tabindex="-1" 
     aria-hidden="@(!showDeleteModal)">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Project</h5>
                <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the project <strong>@project?.Name</strong>?</p>
                <p class="text-muted small">This action cannot be undone. All associated videos and scripts will also be deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="DeleteProject" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                    }
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

@if (showEditModal || showDeleteModal)
{
    <div class="modal-backdrop fade show"></div>
}